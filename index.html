<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Optymalizator Obrazów - Webly Mate</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- Google Fonts: Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Biblioteki Logiki -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        primary: '#1a1a1a',
                        secondary: '#666666',
                        accent: '#e5e5e5',
                        background: '#fafafa',
                        surface: '#ffffff',
                        success: '#22c55e',
                        warning: '#f59e0b',
                        error: '#ef4444',
                    },
                    boxShadow: {
                        'card': '0 1px 3px rgba(0, 0, 0, 0.1)',
                        'card-hover': '0 4px 12px rgba(0, 0, 0, 0.15)',
                    }
                }
            }
        }
    </script>

    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #fafafa;
            color: #1a1a1a;
        }

        /* Webly Components */
        .webly-card {
            background: #ffffff;
            border: 1px solid #e5e5e5;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            transition: all 0.2s ease;
        }

        .webly-input, .webly-select {
            border: 1px solid #e5e5e5;
            border-radius: 8px;
            padding: 10px 12px;
            font-size: 14px;
            transition: all 0.2s ease;
            width: 100%;
            background-color: #fff;
            color: #1a1a1a;
        }
        .webly-input:focus, .webly-select:focus {
            outline: none;
            border-color: #1a1a1a;
            box-shadow: 0 0 0 2px rgba(26, 26, 26, 0.05);
        }

        .btn-primary {
            background-color: #1a1a1a;
            color: white;
            transition: all 0.2s;
        }
        .btn-primary:hover {
            background-color: #333;
            transform: translateY(-1px);
        }
        .btn-primary:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background-color: transparent;
            border: 1px solid #e5e5e5;
            color: #1a1a1a;
            transition: all 0.2s;
        }
        .btn-secondary:hover {
            background-color: #f5f5f5;
            border-color: #ccc;
        }

        /* Drag Zone Active State */
        .drag-active {
            border-color: #1a1a1a !important;
            background-color: #f5f5f5 !important;
        }

        /* Range Slider */
        input[type=range] {
            -webkit-appearance: none;
            background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: #1a1a1a;
            cursor: pointer;
            margin-top: -6px; 
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #e5e5e5;
            border-radius: 2px;
        }

        /* Checkerboard Pattern for Preview */
        .checkerboard {
            background-color: #f9f9f9;
            background-image: 
                linear-gradient(45deg, #eee 25%, transparent 25%, transparent 75%, #eee 75%, #eee), 
                linear-gradient(45deg, #eee 25%, transparent 25%, transparent 75%, #eee 75%, #eee);
            background-position: 0 0, 10px 10px;
            background-size: 20px 20px;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- Navbar -->
    <nav class="bg-white border-b border-accent sticky top-0 z-50">
        <div class="max-w-[1200px] mx-auto px-6 py-4 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 bg-primary text-white rounded flex items-center justify-center">
                    <i class="fa-solid fa-layer-group text-sm"></i>
                </div>
                <span class="font-bold text-lg tracking-tight">Webly Mate <span class="font-normal text-secondary">/ Optimizer</span></span>
            </div>
            <div class="hidden md:block text-xs font-medium px-3 py-1 bg-background rounded border border-accent text-secondary">
                v2.1
            </div>
        </div>
    </nav>

    <main class="max-w-[1200px] mx-auto px-4 md:px-6 py-8 md:py-12 grid grid-cols-1 lg:grid-cols-12 gap-8 flex-grow">
        
        <!-- LEWA KOLUMNA: KONTROLKI -->
        <div class="lg:col-span-8 space-y-6">
            
            <!-- Warning Alert -->
            <div class="bg-[#fffbeb] border border-[#fcd34d] text-[#92400e] px-4 py-3 rounded-lg text-sm flex items-start gap-3">
                <i class="fa-solid fa-triangle-exclamation mt-0.5"></i>
                <div>
                    <span class="font-semibold block mb-1">Uwaga dotycząca wydajności</span>
                    Przetwarzanie odbywa się lokalnie w przeglądarce. Przy dużej liczbie zdjęć (>100) zalecamy dzielenie na mniejsze partie.
                </div>
            </div>

            <div class="webly-card p-6 md:p-8">
                <!-- SEKCJA 1: Źródło -->
                <div class="mb-8">
                    <h2 class="text-lg font-semibold text-primary mb-4 flex items-center gap-3">
                        <span class="bg-primary text-white w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold">1</span> 
                        Wybór plików
                    </h2>
                    
                    <div class="flex flex-col sm:flex-row gap-3 mb-4">
                        <button id="btnSelectFiles" class="flex-1 btn-secondary py-2.5 px-4 rounded-lg font-medium text-sm flex items-center justify-center gap-2">
                            <i class="fa-regular fa-file"></i> Wybierz pliki
                        </button>
                        <button id="btnSelectFolder" class="flex-1 btn-secondary py-2.5 px-4 rounded-lg font-medium text-sm flex items-center justify-center gap-2">
                            <i class="fa-regular fa-folder"></i> Wybierz folder
                        </button>
                    </div>

                    <div id="drop-zone" class="border-2 border-dashed border-[#e5e5e5] rounded-xl p-10 text-center cursor-pointer transition-all hover:bg-[#fafafa] hover:border-[#cccccc] group">
                        <input type="file" id="fileInput" multiple accept="image/*" class="hidden">
                        <input type="file" id="folderInput" webkitdirectory directory class="hidden">
                        <div class="text-secondary group-hover:text-primary transition-colors">
                            <i class="fa-solid fa-cloud-arrow-up text-3xl mb-3"></i>
                            <p class="font-medium">Upuść pliki tutaj</p>
                            <p class="text-xs mt-2 text-[#999999]" id="fileCount">Nie wybrano plików</p>
                        </div>
                    </div>
                </div>

                <div class="w-full h-[1px] bg-accent my-8"></div>

                <!-- SEKCJA 2: Ustawienia -->
                <div class="mb-8">
                    <h2 class="text-lg font-semibold text-primary mb-4 flex items-center gap-3">
                        <span class="bg-primary text-white w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold">2</span> 
                        Parametry i Nazewnictwo
                    </h2>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Format -->
                        <div>
                            <label class="block text-sm font-medium text-primary mb-2">Format Pliku</label>
                            <div class="relative">
                                <select id="formatSelect" class="webly-select appearance-none">
                                    <option value="image/jpeg">JPG (Standard)</option>
                                    <option value="image/webp">WebP (Zalecany do Web)</option>
                                    <option value="image/avif">AVIF (Ultra kompresja)</option>
                                </select>
                                <i class="fa-solid fa-chevron-down absolute right-3 top-3.5 text-xs text-secondary pointer-events-none"></i>
                            </div>
                        </div>

                        <!-- Rozdzielczość -->
                        <div>
                            <label class="block text-sm font-medium text-primary mb-2">Skalowanie</label>
                            <div class="relative">
                                <select id="resizeSelect" class="webly-select appearance-none">
                                    <option value="original">Oryginalny rozmiar</option>
                                    <option value="1920x1080">Full HD (1920x1080) - WWW</option>
                                    <option value="3840x2160">4K UHD (3840x2160)</option>
                                    <option value="1080x1080">Kwadrat (1080x1080) - Social</option>
                                    <option value="1200x630">Facebook / OG Image</option>
                                </select>
                                <i class="fa-solid fa-chevron-down absolute right-3 top-3.5 text-xs text-secondary pointer-events-none"></i>
                            </div>
                        </div>

                        <!-- Nowe Pole: Nazewnictwo -->
                        <div class="md:col-span-2">
                             <label class="block text-sm font-medium text-primary mb-2">Nazewnictwo plików wynikowych</label>
                             <div class="relative">
                                 <select id="namingSelect" class="webly-select appearance-none">
                                     <option value="original">Zachowaj oryginalne nazwy (np. IMG_2024.jpg)</option>
                                     <option value="numbered">Numeracja sekwencyjna (1.jpg, 2.jpg, 3.jpg...)</option>
                                 </select>
                                 <i class="fa-solid fa-chevron-down absolute right-3 top-3.5 text-xs text-secondary pointer-events-none"></i>
                             </div>
                             <p class="text-[10px] text-secondary mt-1">
                                 Numeracja jest nadawana zgodnie z kolejnością plików na liście.
                             </p>
                        </div>
                    </div>

                    <!-- Jakość -->
                    <div class="mt-6">
                        <div class="flex justify-between mb-2">
                            <label class="text-sm font-medium text-primary">Stopień kompresji</label>
                            <span id="qualityValue" class="font-mono font-bold text-primary text-sm">75%</span>
                        </div>
                        <input type="range" id="qualityRange" min="10" max="100" value="75" class="w-full">
                        <div class="flex justify-between text-[10px] text-secondary mt-1 uppercase tracking-wide">
                            <span>Max Kompresja</span>
                            <span>Max Jakość</span>
                        </div>
                    </div>
                </div>

                <div class="w-full h-[1px] bg-accent my-8"></div>

                <!-- SEKCJA 3: Logo -->
                <div class="mb-8">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-lg font-semibold text-primary flex items-center gap-3">
                            <span class="bg-primary text-white w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold">3</span> 
                            Znak wodny
                        </h2>
                        <label class="flex items-center space-x-2 cursor-pointer select-none group">
                            <input type="checkbox" id="logoCheck" class="w-4 h-4 rounded border-gray-300 text-primary focus:ring-primary accent-primary">
                            <span class="text-sm font-medium text-primary group-hover:text-secondary transition-colors">Aktywuj</span>
                        </label>
                    </div>

                    <div id="logoOptions" class="opacity-50 pointer-events-none transition-all duration-300 bg-background p-5 rounded-lg border border-accent">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                            <div>
                                <label class="block text-xs uppercase font-semibold text-secondary mb-2">Plik Logo (PNG)</label>
                                <input type="file" id="logoInput" accept="image/*" class="block w-full text-xs text-secondary
                                file:mr-3 file:py-2 file:px-4
                                file:rounded-md file:border-0
                                file:text-xs file:font-semibold
                                file:bg-primary file:text-white
                                hover:file:bg-[#333] cursor-pointer">
                            </div>
                            <div>
                                <label class="block text-xs uppercase font-semibold text-secondary mb-2">Pozycja</label>
                                <div class="relative">
                                    <select id="logoPosition" class="webly-select appearance-none text-sm">
                                        <option value="bottom-right">Prawy Dolny</option>
                                        <option value="bottom-left">Lewy Dolny</option>
                                        <option value="top-right">Prawy Górny</option>
                                        <option value="top-left">Lewy Górny</option>
                                        <option value="center">Środek</option>
                                    </select>
                                    <i class="fa-solid fa-chevron-down absolute right-3 top-3.5 text-xs text-secondary pointer-events-none"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Action Button -->
                <button id="processBtn" class="w-full btn-primary py-4 rounded-xl shadow-lg transition-all active:scale-[0.99] flex justify-center items-center gap-3 disabled:opacity-50 disabled:cursor-not-allowed">
                    <i class="fa-solid fa-wand-magic-sparkles"></i>
                    <span class="font-semibold text-base">Rozpocznij Optymalizację</span>
                </button>

                <!-- Progress Bar -->
                <div id="progressContainer" class="hidden mt-6">
                    <div class="flex justify-between text-xs font-medium text-primary mb-2">
                        <span id="statusText">Inicjalizacja...</span>
                        <span id="percentText" class="font-mono">0%</span>
                    </div>
                    <div class="w-full bg-[#e5e5e5] rounded-full h-2 overflow-hidden">
                        <div id="progressBar" class="bg-primary h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                </div>

            </div>
        </div>

        <!-- PRAWA KOLUMNA: PODGLĄD (Sticky) -->
        <div class="lg:col-span-4">
            <div class="webly-card p-6 sticky top-24">
                <h3 class="font-bold text-primary mb-2 flex items-center gap-2">
                    <i class="fa-regular fa-eye"></i> Podgląd
                </h3>
                <p class="text-xs text-secondary mb-4 leading-relaxed">
                    Wizualizacja umiejscowienia logo na przykładowym tle. Rzeczywisty efekt zależy od rozmiaru Twoich zdjęć.
                </p>

                <!-- Canvas Container -->
                <div class="checkerboard w-full aspect-video rounded-lg border border-accent overflow-hidden relative flex items-center justify-center">
                    <canvas id="previewCanvas" class="max-w-full max-h-full"></canvas>
                </div>

                <div class="mt-4 flex items-center justify-center gap-2 text-[10px] text-[#999999] uppercase tracking-wider">
                    <i class="fa-solid fa-arrows-rotate"></i> Auto-aktualizacja
                </div>
            </div>
        </div>

    </main>

    <!-- Footer -->
    <footer class="bg-surface border-t border-accent mt-auto py-8">
        <div class="max-w-[1200px] mx-auto px-6 flex flex-col md:flex-row justify-between items-center gap-4">
            <p class="text-xs text-secondary">
                &copy; <script>document.write(new Date().getFullYear())</script> Webly Mate Optimizer. Wszystkie prawa zastrzeżone.
            </p>
            <a href="https://weblymate.com" target="_blank" class="text-xs font-medium text-primary hover:text-secondary transition-colors flex items-center gap-1">
                Odwiedź weblymate.com <i class="fa-solid fa-arrow-up-right-from-square text-[10px]"></i>
            </a>
        </div>
    </footer>

    <!-- Logic Script -->
    <script>
        // --- ZMIENNE ---
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('fileInput');
        const folderInput = document.getElementById('folderInput');
        const btnSelectFiles = document.getElementById('btnSelectFiles');
        const btnSelectFolder = document.getElementById('btnSelectFolder');
        const fileCount = document.getElementById('fileCount');

        const formatSelect = document.getElementById('formatSelect');
        const resizeSelect = document.getElementById('resizeSelect');
        const namingSelect = document.getElementById('namingSelect'); // NOWE
        const qualityRange = document.getElementById('qualityRange');
        const qualityValue = document.getElementById('qualityValue');

        const logoCheck = document.getElementById('logoCheck');
        const logoOptions = document.getElementById('logoOptions');
        const logoInput = document.getElementById('logoInput');
        const logoPosition = document.getElementById('logoPosition');

        const processBtn = document.getElementById('processBtn');
        const progressContainer = document.getElementById('progressContainer');
        const progressBar = document.getElementById('progressBar');
        const statusText = document.getElementById('statusText');
        const percentText = document.getElementById('percentText');

        const previewCanvas = document.getElementById('previewCanvas');
        const previewCtx = previewCanvas.getContext('2d');

        let filesToProcess = [];
        let userLogoImg = null;

        // Placeholder Image
        const placeholderImg = new Image();
        
        function generatePlaceholder() {
            const canvas = document.createElement('canvas');
            canvas.width = 800;
            canvas.height = 450;
            const ctx = canvas.getContext('2d');
            
            // Webly Style Placeholder
            ctx.fillStyle = "#fafafa";
            ctx.fillRect(0, 0, 800, 450);

            // Grid lines
            ctx.strokeStyle = "#e5e5e5";
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(400, 0); ctx.lineTo(400, 450);
            ctx.moveTo(0, 225); ctx.lineTo(800, 225);
            ctx.stroke();

            // Text
            ctx.fillStyle = "#1a1a1a";
            ctx.font = "bold 24px Inter, sans-serif";
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            ctx.fillText("Przykładowe Zdjęcie", 400, 210);
            
            ctx.fillStyle = "#666666";
            ctx.font = "16px Inter, sans-serif";
            ctx.fillText("(Placeholder Tła)", 400, 240);

            placeholderImg.src = canvas.toDataURL();
            placeholderImg.onload = drawPreview;
        }

        // --- OBSŁUGA UI ---

        generatePlaceholder();

        [resizeSelect, logoCheck, logoPosition].forEach(el => {
            el.addEventListener('change', drawPreview);
        });

        qualityRange.addEventListener('input', (e) => {
            qualityValue.textContent = e.target.value + '%';
        });

        logoCheck.addEventListener('change', (e) => {
            if (e.target.checked) {
                logoOptions.classList.remove('opacity-50', 'pointer-events-none');
            } else {
                logoOptions.classList.add('opacity-50', 'pointer-events-none');
            }
        });

        logoInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    const img = new Image();
                    img.onload = () => { 
                        userLogoImg = img; 
                        drawPreview(); 
                    };
                    img.src = event.target.result;
                };
                reader.readAsDataURL(file);
            }
        });

        function drawPreview() {
            const targetDim = getTargetDimensions(placeholderImg.width, placeholderImg.height);
            const previewWidth = 400;
            const aspect = targetDim.w / targetDim.h;
            const previewHeight = previewWidth / aspect;

            previewCanvas.width = previewWidth;
            previewCanvas.height = previewHeight;

            const scale = Math.max(previewWidth / placeholderImg.width, previewHeight / placeholderImg.height);
            const x = (previewWidth / 2) - (placeholderImg.width / 2) * scale;
            const y = (previewHeight / 2) - (placeholderImg.height / 2) * scale;
            
            previewCtx.drawImage(placeholderImg, x, y, placeholderImg.width * scale, placeholderImg.height * scale);

            if (logoCheck.checked && userLogoImg) {
                const previewRatio = previewWidth / targetDim.w;

                const logoW = userLogoImg.width * previewRatio;
                const logoH = userLogoImg.height * previewRatio;

                const marginX = previewWidth * 0.03;
                const marginY = previewHeight * 0.03;

                let lx = 0, ly = 0;
                const pos = logoPosition.value;

                switch(pos) {
                    case 'bottom-right':
                        lx = previewWidth - logoW - marginX;
                        ly = previewHeight - logoH - marginY;
                        break;
                    case 'bottom-left':
                        lx = marginX;
                        ly = previewHeight - logoH - marginY;
                        break;
                    case 'top-right':
                        lx = previewWidth - logoW - marginX;
                        ly = marginY;
                        break;
                    case 'top-left':
                        lx = marginX;
                        ly = marginY;
                        break;
                    case 'center':
                        lx = (previewWidth - logoW) / 2;
                        ly = (previewHeight - logoH) / 2;
                        break;
                }

                // Shadow for preview visibility
                previewCtx.shadowColor = "rgba(0,0,0,0.1)";
                previewCtx.shadowBlur = 4;
                previewCtx.drawImage(userLogoImg, lx, ly, logoW, logoH);
                previewCtx.shadowBlur = 0;
            }
        }

        function getTargetDimensions(origW, origH) {
            const val = resizeSelect.value;
            if (val === 'original') return { w: origW, h: origH };
            const [w, h] = val.split('x').map(Number);
            return { w, h };
        }

        btnSelectFiles.addEventListener('click', () => fileInput.click());
        btnSelectFolder.addEventListener('click', () => folderInput.click());
        
        dropZone.addEventListener('click', (e) => {
            if(e.target !== fileInput && e.target !== folderInput) fileInput.click();
        });

        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, (e) => { e.preventDefault(); e.stopPropagation(); }, false);
        });
        ['dragenter', 'dragover'].forEach(eventName => {
            dropZone.addEventListener(eventName, () => dropZone.classList.add('drag-active'), false);
        });
        ['dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, () => dropZone.classList.remove('drag-active'), false);
        });

        dropZone.addEventListener('drop', (e) => handleFiles(e.dataTransfer.files));
        fileInput.addEventListener('change', (e) => handleFiles(e.target.files));
        folderInput.addEventListener('change', (e) => handleFiles(e.target.files));

        function handleFiles(files) {
            const validFiles = Array.from(files).filter(file => file.type.startsWith('image/'));
            if (validFiles.length > 0) {
                filesToProcess = validFiles;
                let sizeMB = (Array.from(validFiles).reduce((acc, f) => acc + f.size, 0) / (1024*1024)).toFixed(1);
                
                fileCount.innerHTML = `
                    <span class="text-success font-bold"><i class="fa-solid fa-check"></i> Wybrano: ${validFiles.length} plików</span>
                    <span class="block mt-1">Rozmiar całkowity: ${sizeMB} MB</span>
                `;
            }
        }

        processBtn.addEventListener('click', async () => {
            if (filesToProcess.length === 0) {
                alert('Proszę najpierw wybrać pliki!');
                return;
            }

            processBtn.disabled = true;
            processBtn.classList.add('opacity-75');
            progressContainer.classList.remove('hidden');
            
            const zip = new JSZip();
            const format = formatSelect.value;
            const quality = parseInt(qualityRange.value) / 100;
            const useLogo = logoCheck.checked && userLogoImg;
            const logoPos = logoPosition.value;
            const resizeMode = resizeSelect.value;
            
            // POBRANIE TRYBU NAZEWNICTWA
            const namingMode = namingSelect.value;

            let ext = ".jpg";
            if (format === "image/webp") ext = ".webp";
            if (format === "image/avif") ext = ".avif";

            let processedCount = 0;

            for (let i = 0; i < filesToProcess.length; i++) {
                const file = filesToProcess[i];
                statusText.textContent = `Przetwarzanie: ${file.name}`;
                
                try {
                    const blob = await processImage(file, format, quality, resizeMode, useLogo, userLogoImg, logoPos);
                    
                    // --- LOGIKA NAZEWNICTWA ---
                    let fileName;
                    if (namingMode === 'numbered') {
                        // Numeracja sekwencyjna (1, 2, 3...)
                        fileName = `${i + 1}`;
                    } else {
                        // Oryginalna nazwa
                        fileName = file.name.substring(0, file.name.lastIndexOf('.')) || file.name;
                    }
                    
                    zip.file(`${fileName}${ext}`, blob);

                } catch (err) {
                    console.error("Błąd pliku:", file.name, err);
                }

                processedCount++;
                const percent = Math.round((processedCount / filesToProcess.length) * 100);
                progressBar.style.width = `${percent}%`;
                percentText.textContent = `${percent}%`;

                if (i % 3 === 0) await new Promise(r => setTimeout(r, 10));
            }

            statusText.textContent = "Pakowanie archiwum ZIP...";
            try {
                const content = await zip.generateAsync({ type: "blob" });
                saveAs(content, `webly_optimized_${new Date().getTime()}.zip`);
                statusText.textContent = "Gotowe! Pobieranie...";
            } catch (e) {
                statusText.textContent = "Błąd pakowania ZIP.";
                alert("Wystąpił błąd przy tworzeniu ZIP.");
            }

            setTimeout(() => {
                processBtn.disabled = false;
                processBtn.classList.remove('opacity-75');
                statusText.textContent = "Zakończono.";
            }, 2000);
        });

        function processImage(file, mimeType, quality, resizeMode, useLogo, logoImg, logoPos) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');

                        let targetW, targetH;
                        
                        if (resizeMode === 'original') {
                            targetW = img.width;
                            targetH = img.height;
                        } else {
                            [targetW, targetH] = resizeMode.split('x').map(Number);
                        }

                        canvas.width = targetW;
                        canvas.height = targetH;

                        const scale = Math.max(targetW / img.width, targetH / img.height);
                        const x = (targetW / 2) - (img.width / 2) * scale;
                        const y = (targetH / 2) - (img.height / 2) * scale;

                        ctx.imageSmoothingEnabled = true;
                        ctx.imageSmoothingQuality = 'high';
                        ctx.drawImage(img, x, y, img.width * scale, img.height * scale);

                        if (useLogo && logoImg) {
                            const logoW = logoImg.width;
                            const logoH = logoImg.height;
                            
                            const marginX = targetW * 0.03;
                            const marginY = targetH * 0.03;

                            let lx = 0, ly = 0;

                            switch(logoPos) {
                                case 'bottom-right':
                                    lx = targetW - logoW - marginX;
                                    ly = targetH - logoH - marginY;
                                    break;
                                case 'bottom-left':
                                    lx = marginX;
                                    ly = targetH - logoH - marginY;
                                    break;
                                case 'top-right':
                                    lx = targetW - logoW - marginX;
                                    ly = marginY;
                                    break;
                                case 'top-left':
                                    lx = marginX;
                                    ly = marginY;
                                    break;
                                case 'center':
                                    lx = (targetW - logoW) / 2;
                                    ly = (targetH - logoH) / 2;
                                    break;
                            }
                            ctx.drawImage(logoImg, lx, ly, logoW, logoH);
                        }

                        canvas.toBlob((blob) => {
                            if (!blob) reject("Canvas error");
                            canvas.width = 1; canvas.height = 1;
                            resolve(blob);
                        }, mimeType, quality);
                    };
                    img.onerror = reject;
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }
    </script>
</body>
</html>
